{% extends "base.html" %} {% block title %} Orders {% endblock %} {% block content %} {% load static %}



<nav>{% include "components/navbar.html" %}</nav>
<div>{% include "components/sidebar.html" %}</div>

<div class="d-flex" id="main">

 
<div class=" container pt-3">
  <hr />
  <div class="d-md-flex d-block pt-3 justify-content-between">
    <div>
      <input
        type="text"
        class="form-control"
        id="table-filter"
        placeholder="Search..."
      />
    </div>
    <div class="d-flex align-items-center justify-content-end w-100">
      <div class="pt-md-0 pt-3">
        <button
          class="blue-btn"
          data-bs-toggle="modal"
          data-bs-target="#add_order"
          data-bs-whatever="add_order"
        >
          Add New Order
        </button>
      </div>
      <div class="ps-3 pt-md-0 pt-3">
        <button class="blue-btn" data-bs-toggle="collapse" data-bs-target="#filterform" aria-expanded="false" aria-controls="filterform"><i class="fa-solid fa-filter"></i></button>
      </div>
    </div>
  </div>

  <div>{% include "components/filter.html" %}</div>


  <div class="row pt-3">
    <div class="col-12">
      <div class="table-responsive">
        <table id="orderTable">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Order Id</th>
              <th scope="col">Product</th>
              <th scope="col">Quantity</th>
              <th scope="col">Ordered Date</th>
              <th scope="col">Price</th>
              <th scope="col">Delivery Date</th>
              <th scope="col">Status</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if not orders %}
              {% for order in all_orders %}
                  <tr>
                      <td scope="row">{{ forloop.counter }}</td>
                      <td>{{ order.order_id }}</td>
                      <td>{{ order.product_name }}</td>
                      <td>{{ order.quantity }}</td>
                      <td>{{ order.ordered_date }}</td>
                      <td>{{ order.price }}</td>
                      <td>{{ order.delivery_date }}</td>
                      <td>{{ order.status }}</td>
                      <td>
                        <div class="d-flex justify-content-center align-items-center">
                          <div>
                            <a
                              href=""
                              data-bs-toggle="modal"
                              data-bs-target="#edit_order"
                              data-bs-whatever="edit_order"
                              data-order-id="{{ order.order_id }}"
                              
                              ><i
                                class="fa-solid fa-pen-to-square pe-2"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Edit"
                              ></i
                            ></a>
                          </div>
                          <div>
                            <!-- <form
                              method="post"
                              action="{% url 'delete_order' order.order_id %}"
                            >
                              {% csrf_token %} -->
                              <input
                                type="hidden"
                                name="order_id"
                                value="{{ order.order_id }}"
                              />
                              <button
                                style="
                                  border: none;
                                  background-color: transparent;
                                  margin-left: 10px;
                                "
                                type="submit"
                                class="text-danger delete-button"
                                data-bs-toggle="modal"
                                data-bs-target="#delete_order"
                                data-bs-whatever="delete_order"
                              >
                                <i
                                  class="fa-solid fa-trash"
                                  data-bs-toggle="tooltip"
                                  data-bs-placement="top"
                                  title="Delete"
                                ></i>
                              </button>
                            <!-- </form> -->
                          </div>
                        </div>
                      </td>
                  </tr>
              {% endfor %}
          {% else %}
              {% for order in orders %}
                  <tr>
                      <td scope="row">{{ forloop.counter }}</td>
                      <td>{{ order.order_id }}</td>
                      <td>{{ order.product_name }}</td>
                      <td>{{ order.quantity }}</td>
                      <td>{{ order.ordered_date }}</td>
                      <td>{{ order.price }}</td>
                      <td>{{ order.delivery_date }}</td>
                      <td>{{ order.status }}</td>
                      <td>
                        <div class="d-flex justify-content-center align-items-center">
                          <div>
                            <a
                              href=""
                              data-bs-toggle="modal"
                              data-bs-target="#edit_order"
                              data-bs-whatever="edit_order"
                              data-order-id="{{ order.order_id }}"
                              data-product-name="{{ order.product_name }}"
                              data-order-quantity ="{{ order.quantity }}"
                              data-ordered-date ="{{ order.ordered_date }}"
                              data-order-price ="{{ order.price }}"
                              data-delivery-date="{{ order.delivery_date }}"
                              data-order-status="{{ order.status }}"
                              ><i
                                class="fa-solid fa-pen-to-square pe-2"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                title="Edit"
                              ></i
                            ></a>
                          </div>
                          <div>
                            <!-- <form
                              method="post"
                              action="{% url 'delete_order' order.order_id %}"
                            >
                              {% csrf_token %} -->
                              <input
                                type="hidden"
                                name="order_id"
                                value="{{ order.order_id }}"
                              />
                              <button
                                style="border: none; background-color: transparent; margin-left: 10px;"
                                type="button"
                                class="text-danger delete-button"
                                data-bs-toggle="modal"
                                data-bs-target="#delete_order"
                                data-bs-whatever="delete_order"
                                data-order-id="{{ order.order_id }}"
                                data-product-name="{{ order.product_name }}"
                                data-order-quantity="{{ order.quantity }}"
                                data-ordered-date="{{ order.ordered_date }}"
                                data-order-price="{{ order.price }}"
                                data-delivery-date="{{ order.delivery_date }}"
                                data-order-status="{{ order.status }}"
                            >
                                <i class="fa-solid fa-trash" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete"></i>
                            </button>

                            <!-- </form> -->
                          </div>
                        </div>
                      </td>
                  </tr>
              {% endfor %}
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="add_order"
  tabindex="-1"
  aria-labelledby="add_order"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">New Orders</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form method="post" action="{% url 'addOrder' %}">
          {% csrf_token %}
          <input
            type="hidden"
            id="product_url"
            value="{% url 'order_product_name' %}"
          />
          <div class="mb-3">
            <label for="order_product_name" class="col-form-label"
              >Product:</label
            >
            <select
              name="order_product_name"
              id="product_dropdown"
              class="form-control"
            >
              <option value="">Select a product</option>
              {% for product in products %}
              <option value="{{ product.product_id }}">
                {{ product.product_name }}
              </option>
              {% endfor%}
            </select>
          </div>

          <div class="mb-3">
            <label for="quantity" class="col-form-label">Quantity:</label>
            <input
              type="number"
              class="form-control"
              name="quantity"
              id="quantity"
              required
            />
          </div>

          <div class="mb-3">
            <label for="ordered_date" class="form-label">Ordered Date:</label>
            <input
              type="date"
              class="form-control datepicker"
              name="ordered_date"
              id="ordered_date"
              required
            />
          </div>

          <div class="mb-3">
            <label for="price" class="form-label">Price:</label>
            <input
              type="number"
              class="form-control"
              name="price"
              id="price"
              required
            />
          </div>

          <div class="mb-3">
            <label for="delivery_date" class="form-label">Delivery Date:</label>
            <input
              type="date"
              class="form-control datepicker"
              name="delivery_date"
              id="delivery_date"
              required
            />
          </div>
          <div class="text-danger">
            {% if error_message %}
            <p>Error: {{ error_message }}</p>
            {% endif %}
          </div>

          <div class="mb-3">
            <label for="status" class="form-label">Status:</label>
            <select class="form-control" name="status" id="status">
              <option value="Ongoing">Ongoing</option>
              <option value="Pending">Pending</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>

            </select>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">Add Order</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="edit_order"
  tabindex="-1"
  aria-labelledby="edit_order"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Edit Order</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form method="post" action="{% url 'editOrder' %}">
          {% csrf_token %}
          <input type="hidden" name="old_orderid" id="old_orderid" />
          <input type="hidden" name="new_product_name" id="new_product_name" />

          <div class="mb-3">
            <label for="edit_quantity" class="col-form-label">Quantity:</label>
            <input
              type="number"
              class="form-control"
              name="edit_quantity"
              id="edit_quantity"
            />
          </div>

        

          <div class="mb-3">
            <label for="edit_price" class="form-label">Price:</label>
            <input
              type="number"
              class="form-control"
              name="edit_price"
              id="edit_price"
            />
          </div>

          <div class="mb-3">
            <label for="edit_delivery_date" class="form-label"
              >Delivery Date:</label
            >
            <input
              type="date"
              class="form-control datepicker"
              name="edit_delivery_date"
              id="edit_delivery_date"
            />

            <div class="text-danger" id="deliveryDateError"></div>

          </div>

          <div class="mb-3">
            <label for="edit_status" class="form-label">Status:</label>
            <select class="form-control" name="edit_status" id="edit_status">
              <option value="Ongoing">Ongoing</option>
              <option value="Pending">Pending</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>
            </select>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Edit Order</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="delete_order" tabindex="-1" aria-labelledby="delete_order" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="delete_OrderLabel">Delete Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="deleteOrderId" name="product_id" value="">
        <p>Are you sure you want to delete the order?</p>
      </div>
      <!-- <form id="deleteOrderForm" action="{% url 'delete_order' 0 %}" method="post">
        {% csrf_token %}
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="deleteOrder()">Delete</button>
        </div>
      </form> -->
      <form id="deleteOrderForm" method="post">
        {% csrf_token %}
        <input type="hidden" name="order_id" id="deleteOrderId" value="0"> <!-- Default value set to 0, will be updated dynamically -->
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="deleteOrder()">Delete</button>
        </div>
    </form> 
    </div>
  </div>
</div>

</div>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    var orderedDateInput = document.getElementById('ordered_date');
    var deliveryDateInput = document.getElementById('delivery_date');

    orderedDateInput.addEventListener('input', function () {
      var orderedDate = new Date(orderedDateInput.value);
      var formattedOrderedDate = orderedDate.toISOString().split('T')[0];
      
      // Set the min attribute for delivery date
      deliveryDateInput.setAttribute('min', formattedOrderedDate);

      // Clear the value if it's invalid
      if (new Date(deliveryDateInput.value) < orderedDate) {
        deliveryDateInput.value = formattedOrderedDate;
      }
    });

   
  });

  function deleteOrder() {
    // Get the order ID from the data attribute
    var orderId = document.querySelector(".delete-button").dataset.orderId;

    // Log the orderId to the console for debugging
    console.log("Order ID to delete:", orderId);

    // Set the order ID in the hidden input field
    document.getElementById("deleteOrderId").value = orderId;

    // Set the action URL for the form with the correct order ID
    document.getElementById("deleteOrderForm").action = "{% url 'delete_order' 0 %}".replace('0', orderId);

    // Submit the form
    document.getElementById("deleteOrderForm").submit();
}
</script>


<script src="{% static 'script.js' %}"></script>
{% load static %} {% endblock %}
